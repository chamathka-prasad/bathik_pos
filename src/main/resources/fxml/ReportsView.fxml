<?xml version="1.0" encoding="UTF-8"?>

<?import com.jfoenix.controls.JFXButton?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.control.cell.PropertyValueFactory?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.text.Font?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.chamathka.bathikpos.controller.ReportsController"
            prefWidth="1200"
            prefHeight="700"
            style="-fx-background-color: #f5f5f5;">

    <!-- Top Bar -->
    <top>
        <HBox alignment="CENTER_LEFT" spacing="15" style="-fx-background-color: white; -fx-padding: 15 20;">
            <JFXButton text="â† Back to Dashboard"
                      onAction="#handleBackToDashboard"
                      style="-fx-background-color: #e0e7ff; -fx-text-fill: #4338ca; -fx-background-radius: 5;">
                <font>
                    <Font name="System Bold" size="12"/>
                </font>
            </JFXButton>

            <Region HBox.hgrow="ALWAYS"/>

            <Label text="Reports & Analytics" textFill="#1f2937">
                <font>
                    <Font name="System Bold" size="20"/>
                </font>
            </Label>

            <Region HBox.hgrow="ALWAYS"/>
        </HBox>
    </top>

    <!-- Center - Tabbed Reports -->
    <center>
        <TabPane fx:id="reportsTabPane" tabClosingPolicy="UNAVAILABLE" style="-fx-padding: 20;">

            <!-- Low Stock Report Tab -->
            <Tab text="Low Stock">
                <VBox spacing="15" style="-fx-padding: 15;">
                    <!-- Header -->
                    <HBox alignment="CENTER_LEFT" spacing="15">
                        <Label text="Low Stock Alert" textFill="#1f2937">
                            <font>
                                <Font name="System Bold" size="16"/>
                            </font>
                        </Label>

                        <Region HBox.hgrow="ALWAYS"/>

                        <JFXButton text="Refresh"
                                  onAction="#handleRefreshLowStock"
                                  style="-fx-background-color: #6366f1; -fx-text-fill: white; -fx-background-radius: 5;">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </JFXButton>
                    </HBox>

                    <!-- Stats Card -->
                    <HBox spacing="15">
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" HBox.hgrow="ALWAYS">
                            <Label text="Items Below Threshold" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="lowStockCountLabel" text="0" textFill="#1f2937">
                                <font>
                                    <Font name="System Bold" size="24"/>
                                </font>
                            </Label>
                        </VBox>
                    </HBox>

                    <!-- Low Stock Table -->
                    <TableView fx:id="lowStockTable" VBox.vgrow="ALWAYS">
                        <columns>
                            <TableColumn text="Product" prefWidth="250">
                                <cellValueFactory>
                                    <PropertyValueFactory property="productName"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="SKU" prefWidth="120">
                                <cellValueFactory>
                                    <PropertyValueFactory property="sku"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Size" prefWidth="80">
                                <cellValueFactory>
                                    <PropertyValueFactory property="size"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Color" prefWidth="100">
                                <cellValueFactory>
                                    <PropertyValueFactory property="color"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Current Stock" prefWidth="120" style="-fx-alignment: CENTER;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="currentStock"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Reorder Level" prefWidth="120" style="-fx-alignment: CENTER;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="reorderLevel"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Selling Price" prefWidth="120" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="sellingPrice"/>
                                </cellValueFactory>
                            </TableColumn>
                        </columns>
                    </TableView>
                </VBox>
            </Tab>

            <!-- Sales Report Tab -->
            <Tab text="Sales Report">
                <VBox spacing="15" style="-fx-padding: 15;">
                    <!-- Date Range Selector -->
                    <HBox alignment="CENTER_LEFT" spacing="15" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;">
                        <Label text="From:">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </Label>
                        <DatePicker fx:id="salesStartDate" prefWidth="150"/>

                        <Label text="To:">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </Label>
                        <DatePicker fx:id="salesEndDate" prefWidth="150"/>

                        <JFXButton text="Generate Report"
                                  onAction="#handleGenerateSalesReport"
                                  style="-fx-background-color: #6366f1; -fx-text-fill: white; -fx-background-radius: 5;">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </JFXButton>

                        <Region HBox.hgrow="ALWAYS"/>

                        <Label fx:id="salesReportStatus" text="" textFill="#6b7280">
                            <font>
                                <Font size="12"/>
                            </font>
                        </Label>
                    </HBox>

                    <!-- Sales Summary Cards -->
                    <GridPane hgap="15" vgap="15">
                        <columnConstraints>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                        </columnConstraints>

                        <!-- Total Sales Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="0">
                            <Label text="Total Sales" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalSalesLabel" text="LKR 0.00" textFill="#059669">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Transactions Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="1">
                            <Label text="Transactions" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalTransactionsLabel" text="0" textFill="#3b82f6">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Discount Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="2">
                            <Label text="Total Discount" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalDiscountLabel" text="LKR 0.00" textFill="#f59e0b">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Avg Transaction Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="3">
                            <Label text="Avg Transaction" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="avgTransactionLabel" text="LKR 0.00" textFill="#8b5cf6">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>
                    </GridPane>

                    <!-- Sales Details Tabs -->
                    <TabPane tabClosingPolicy="UNAVAILABLE" VBox.vgrow="ALWAYS">
                        <!-- Sales by User Tab -->
                        <Tab text="By User">
                            <TableView fx:id="salesByUserTable">
                                <columns>
                                    <TableColumn text="Username" prefWidth="250">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="username"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Transactions" prefWidth="150" style="-fx-alignment: CENTER;">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="transactionCount"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Total Amount" prefWidth="200" style="-fx-alignment: CENTER_RIGHT;">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="totalAmount"/>
                                        </cellValueFactory>
                                    </TableColumn>
                                </columns>
                            </TableView>
                        </Tab>

                        <!-- Sales by Customer Tab -->
                        <Tab text="By Customer">
                            <TableView fx:id="salesByCustomerTable">
                                <columns>
                                    <TableColumn text="Customer Name" prefWidth="250">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="customerName"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Phone" prefWidth="150">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="phoneNumber"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Transactions" prefWidth="120" style="-fx-alignment: CENTER;">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="transactionCount"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Total Amount" prefWidth="150" style="-fx-alignment: CENTER_RIGHT;">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="totalAmount"/>
                                        </cellValueFactory>
                                    </TableColumn>
                                </columns>
                            </TableView>
                        </Tab>

                        <!-- Sales by Payment Type Tab -->
                        <Tab text="By Payment Type">
                            <TableView fx:id="salesByPaymentTable">
                                <columns>
                                    <TableColumn text="Payment Type" prefWidth="300">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="paymentType"/>
                                        </cellValueFactory>
                                    </TableColumn>

                                    <TableColumn text="Total Amount" prefWidth="250" style="-fx-alignment: CENTER_RIGHT;">
                                        <cellValueFactory>
                                            <PropertyValueFactory property="amount"/>
                                        </cellValueFactory>
                                    </TableColumn>
                                </columns>
                            </TableView>
                        </Tab>
                    </TabPane>
                </VBox>
            </Tab>

            <!-- Profit Report Tab (Admin Only) -->
            <Tab text="Profit Report" fx:id="profitReportTab">
                <VBox spacing="15" style="-fx-padding: 15;">
                    <!-- Date Range Selector -->
                    <HBox alignment="CENTER_LEFT" spacing="15" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;">
                        <Label text="From:">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </Label>
                        <DatePicker fx:id="profitStartDate" prefWidth="150"/>

                        <Label text="To:">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </Label>
                        <DatePicker fx:id="profitEndDate" prefWidth="150"/>

                        <JFXButton text="Generate Report"
                                  onAction="#handleGenerateProfitReport"
                                  style="-fx-background-color: #059669; -fx-text-fill: white; -fx-background-radius: 5;">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </JFXButton>

                        <Region HBox.hgrow="ALWAYS"/>

                        <Label fx:id="profitReportStatus" text="" textFill="#6b7280">
                            <font>
                                <Font size="12"/>
                            </font>
                        </Label>
                    </HBox>

                    <!-- Profit Summary Cards -->
                    <GridPane hgap="15" vgap="15">
                        <columnConstraints>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                            <ColumnConstraints percentWidth="25"/>
                        </columnConstraints>

                        <!-- Revenue Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="0">
                            <Label text="Total Revenue" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalRevenueLabel" text="LKR 0.00" textFill="#3b82f6">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Cost Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="1">
                            <Label text="Total Cost" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalCostLabel" text="LKR 0.00" textFill="#ef4444">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Profit Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="2">
                            <Label text="Net Profit" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="totalProfitLabel" text="LKR 0.00" textFill="#059669">
                                <font>
                                    <Font name="System Bold" size="24"/>
                                </font>
                            </Label>
                        </VBox>

                        <!-- Margin Card -->
                        <VBox spacing="5" style="-fx-background-color: white; -fx-padding: 15; -fx-background-radius: 8;" GridPane.columnIndex="3">
                            <Label text="Profit Margin" textFill="#6b7280">
                                <font>
                                    <Font size="12"/>
                                </font>
                            </Label>
                            <Label fx:id="profitMarginLabel" text="0.00%" textFill="#8b5cf6">
                                <font>
                                    <Font name="System Bold" size="20"/>
                                </font>
                            </Label>
                        </VBox>
                    </GridPane>

                    <!-- Profit Details Table -->
                    <TableView fx:id="profitDetailsTable" VBox.vgrow="ALWAYS">
                        <columns>
                            <TableColumn text="Date" prefWidth="120">
                                <cellValueFactory>
                                    <PropertyValueFactory property="saleDate"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Product" prefWidth="180">
                                <cellValueFactory>
                                    <PropertyValueFactory property="productName"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="SKU" prefWidth="100">
                                <cellValueFactory>
                                    <PropertyValueFactory property="sku"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Qty" prefWidth="60" style="-fx-alignment: CENTER;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="quantity"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Cost Price" prefWidth="100" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="costPrice"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Selling Price" prefWidth="110" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="sellingPrice"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Revenue" prefWidth="110" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="revenue"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Cost" prefWidth="100" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="cost"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Profit" prefWidth="110" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="profit"/>
                                </cellValueFactory>
                            </TableColumn>
                        </columns>
                    </TableView>
                </VBox>
            </Tab>

            <!-- Top Customers Tab -->
            <Tab text="Top Customers">
                <VBox spacing="15" style="-fx-padding: 15;">
                    <!-- Header -->
                    <HBox alignment="CENTER_LEFT" spacing="15">
                        <Label text="Top 20 Customers by Purchase Amount" textFill="#1f2937">
                            <font>
                                <Font name="System Bold" size="16"/>
                            </font>
                        </Label>

                        <Region HBox.hgrow="ALWAYS"/>

                        <JFXButton text="Refresh"
                                  onAction="#handleRefreshTopCustomers"
                                  style="-fx-background-color: #6366f1; -fx-text-fill: white; -fx-background-radius: 5;">
                            <font>
                                <Font name="System Bold" size="13"/>
                            </font>
                        </JFXButton>
                    </HBox>

                    <!-- Top Customers Table -->
                    <TableView fx:id="topCustomersTable" VBox.vgrow="ALWAYS">
                        <columns>
                            <TableColumn text="Rank" prefWidth="60" style="-fx-alignment: CENTER;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="rank"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Customer Name" prefWidth="250">
                                <cellValueFactory>
                                    <PropertyValueFactory property="customerName"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Phone" prefWidth="150">
                                <cellValueFactory>
                                    <PropertyValueFactory property="phoneNumber"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Visit Count" prefWidth="120" style="-fx-alignment: CENTER;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="visitCount"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Total Purchase" prefWidth="150" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="totalPurchase"/>
                                </cellValueFactory>
                            </TableColumn>

                            <TableColumn text="Avg Purchase" prefWidth="150" style="-fx-alignment: CENTER_RIGHT;">
                                <cellValueFactory>
                                    <PropertyValueFactory property="avgPurchase"/>
                                </cellValueFactory>
                            </TableColumn>
                        </columns>
                    </TableView>
                </VBox>
            </Tab>

        </TabPane>
    </center>
</BorderPane>
